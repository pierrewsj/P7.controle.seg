<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stellantis - Menu</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@400;600;700" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
  <style>
    .menu-card{ max-width:460px; width:90%; text-align:center; }
    .usuario{ margin-top: .75rem; font-size:.95rem; color: var(--cor-texto-suave); }
    .cta{ display:flex; flex-direction:column; gap:1rem; }
    .btn-emoji{ font-size:1.1rem; }
  </style>
</head>
<body>
  <div id="toast-container"></div>

  <div class="container menu-card">
    <header class="header-app">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div>
          <div class="brand-title">STELLANTIS</div>
          <div class="subtitle">Seguran√ßa Patrimonial</div>
        </div>
      </div>
      <button id="themeToggle" class="btn btn-secondary" style="padding:.4rem .6rem;">Tema</button>
    </header>

    <div class="cta" style="margin-top:.6rem;">
      <button class="btn btn-emoji" onclick="location.href='controle_p7_industrializacao.html'">üöó Ve√≠culos - Industrializa√ß√£o</button>
      <button class="btn btn-emoji" onclick="location.href='controle_p7_comissao_seguro.html'">üõ°Ô∏è Ve√≠culos - Comiss√£o de Seguro</button>
      <button class="btn btn-secondary" onclick="finalizarTurno()">üì§ Finalizar turno</button>
    </div>

    <div class="usuario" id="usuarioExibido"></div>
  </div>

  <!-- Overlay de Progresso -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-box">
      <div class="progress-title">Gerando planilha</div>
      <div class="progress-bar"><span id="progressBar"></span></div>
      <div class="progress-text" id="progressText">Preparando dados‚Ä¶</div>
    </div>
  </div>

  <script>
    // Tema
    (function(){
      const theme = localStorage.getItem('theme') || 'dark';
      if(theme==='light') document.documentElement.classList.add('theme-light');
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        document.documentElement.classList.toggle('theme-light');
        localStorage.setItem('theme', document.documentElement.classList.contains('theme-light') ? 'light' : 'dark');
      });
    })();

    const showToast = (msg) => {
      const c = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className='toast'; t.textContent=msg; c.appendChild(t);
      setTimeout(()=> t.remove(), 2600);
    };

    document.addEventListener('DOMContentLoaded', () => {
      const u = localStorage.getItem('usuario')||"", r = localStorage.getItem('registro')||"";
      if(u||r) document.getElementById('usuarioExibido').textContent = `üë§ ${u}${r?" / "+r:""}`;
    });

    // Confirma√ß√£o + export j√° existiam; adicionamos overlay de progresso
    async function finalizarTurno() {
      try {
        const dadosChassi   = JSON.parse(localStorage.getItem('tabelaChassi') || '[]');
        const dadosComissao = JSON.parse(localStorage.getItem('tabelaComissaoSeguro') || '[]');
        const semDados = (!dadosChassi || dadosChassi.length === 0) && (!dadosComissao || dadosComissao.length === 0);
        if (semDados) { showToast('N√£o h√° dados para exportar.'); window.location.href='index.html'; return; }

        if (!confirm('Tem certeza que deseja exportar dados e sair?')) return;

        await exportarPlanilhaFinal(dadosChassi, dadosComissao);
      } catch (e) {
        console.error(e);
        showToast('Erro ao processar a finaliza√ß√£o.');
      }
    }

    function showProgress(show, pct=0, txt=''){
      const ov = document.getElementById('progressOverlay');
      const bar = document.getElementById('progressBar');
      const t = document.getElementById('progressText');
      ov.style.display = show ? 'flex' : 'none';
      if (show) { bar.style.width = pct + '%'; if (txt) t.textContent = txt; }
    }

    async function exportarPlanilhaFinal(dadosChassi, dadosComissao){
      if (!window.ExcelJS || !window.saveAs) { showToast('Bibliotecas ExcelJS/FileSaver n√£o carregadas.'); return; }
      try {
        showProgress(true, 10, 'Criando planilha‚Ä¶');
        const workbook = new ExcelJS.Workbook();

        const ws1 = workbook.addWorksheet('controle de ve√≠culos industrializa√ß√£o');
        ws1.columns = [
          { header: 'Setor', key: 'setor', width: 18 },
          { header: 'Turno', key: 'turno', width: 12 },
          { header: 'Controlador de acesso', key: 'controlador', width: 24 },
          { header: 'N√∫mero de chassi', key: 'chassi', width: 22 },
          { header: 'Data e Hora', key: 'dataHora', width: 22 }
        ];
        (dadosChassi||[]).forEach(d => ws1.addRow(d));
        showProgress(true, 30, 'Aplicando prote√ß√£o‚Ä¶');
        try { await ws1.protect('1234', { selectLockedCells: true, selectUnlockedCells: false }); ws1.eachRow(r=>{ r.protection={locked:true}; }); } catch(e){}

        const ws2 = workbook.addWorksheet('controle de ve√≠culos comiss√£o de seguro');
        ws2.columns = [
          { header: 'Setor', key: 'setor', width: 18 },
          { header: 'Turno', key: 'turno', width: 12 },
          { header: 'Controlador de acesso', key: 'controlador', width: 24 },
          { header: 'Ve√≠culo (placa/chassi)', key: 'veiculo', width: 24 },
          { header: 'Observa√ß√µes', key: 'observacoes', width: 28 },
          { header: 'Data e Hora', key: 'dataHora', width: 22 }
        ];
        (dadosComissao||[]).forEach(d => ws2.addRow(d));
        try { await ws2.protect('1234', { selectLockedCells: true, selectUnlockedCells: false }); ws2.eachRow(r=>{ r.protection={locked:true}; }); } catch(e){}

        showProgress(true, 60, 'Gerando arquivo‚Ä¶');
        const buffer = await workbook.xlsx.writeBuffer();

        const obterTurno = () => {
          try {
            const reg = JSON.parse(localStorage.getItem('registro') || 'null');
            if (reg && reg.turno) return reg.turno;
          } catch(e){}
          if (Array.isArray(dadosChassi) && dadosChassi.length && dadosChassi[0].turno) return dadosChassi[0].turno;
          if (Array.isArray(dadosComissao) && dadosComissao.length && dadosComissao[0].turno) return dadosComissao[0].turno;
          return 'Turno';
        };
        const turnoNome = obterTurno();
        const agora = new Date();
        const dd = String(agora.getDate()).padStart(2,'0');
        const mm = String(agora.getMonth()+1).padStart(2,'0');
        const yyyy = String(agora.getFullYear());
        const HH = String(agora.getHours()).padStart(2,'0');
        const MM = String(agora.getMinutes()).padStart(2,'0');
        const nome = `Relat√≥rio - ${turnoNome} - ${dd}-${mm}-${yyyy} - ${HH}h${MM}.xlsx`;

        showProgress(true, 85, 'Salvando‚Ä¶');
        saveAs(new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), nome);
        showProgress(true, 100, 'Conclu√≠do!');
        setTimeout(()=> showProgress(false), 700);

        localStorage.clear();
        if (sessionStorage && sessionStorage.clear) sessionStorage.clear();
        setTimeout(()=>{ window.location.href='index.html'; }, 800);
      } catch (e) {
        console.error(e);
        showProgress(false);
        showToast('Falha na gera√ß√£o da planilha.');
      }
    }
  </script>
</body>
</html>
