<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portaria 07 - Controle de Chassi</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <style>
    /* Ajuste visual do √≠cone de confirma√ß√£o: menor e dentro do campo */
    #chassiConfirmIcon{
      position:absolute; right:10px; top:50%; transform: translateY(-50%) scale(1);
      width:40px; height:40px; font-size:2rem; opacity:0; display:flex;
      align-items:center; justify-content:center; color:#35ff5a;
      background: rgba(255,255,255,0.8); border-radius:50%;
      box-shadow: 0 0 18px 6px #26e76e66, 0 0 0 3px #57ffa733;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    #chassiConfirmIcon.visible{ opacity:1; transform: translateY(-50%) scale(1.06); }
  </style>
</head>
<body>
  <div id="toast-container"></div>

  <div class="container">
    <header class="header-app">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div>
          <div class="brand-title">STELLANTIS</div>
          <div class="subtitle">Seguran√ßa Patrimonial</div>
        </div>
      </div>
      <div class="button-row">
        <button class="btn btn-secondary" onclick="window.location.href='interface_principal.html'">Menu</button>
        <button class="btn btn-secondary" id="themeToggle">Tema</button>
      </div>
    </header>

    <h3 style="text-align:center; color:var(--cor-primaria);">Controle de Ve√≠culos - Industrializa√ß√£o</h3>

    <div class="form-grid">
      <label>Setor
        <input id="setor" class="input" type="text" value="Portaria 07" readonly />
      </label>
      <label>Turno
        <input id="turno" class="input" type="text" readonly />
      </label>
      <label style="grid-column: span 2; position:relative;">N√∫mero de chassi
        <input id="numeroChassi" class="input" type="text" autocomplete="off" autofocus />
        <span id="chassiConfirmIcon"><i data-feather="check-circle"></i></span>
      </label>
      <label style="grid-column: span 2;">Controlador de acesso
        <input id="controladorAcesso" class="input" type="text" />
      </label>
    </div>

    <div class="auto-save-icon">üíæ Salvamento autom√°tico</div>
    <div class="kpi" id="kpiTotal">Total de ve√≠culos: 0</div>

    <div class="button-row" id="botoesInternos">
      <!-- Internos: manter como est√° (n√£o alteramos nomes/ordem/estilo base) -->
      <button id="btnAdicionar" onclick="adicionarItem()"><i data-feather="plus-circle"></i>Adicionar</button>
      <button id="btnDesfazer" onclick="desfazerUltimo()"><i data-feather="rotate-ccw"></i>Desfazer</button>
      <button id="btnEditarSenha" onclick="editarSenha()"><i data-feather="key"></i>Editar senha</button>
      <button id="btnFecharBotoesInternos" onclick="ocultarBotoesInternos()"><i data-feather="x"></i>Fechar</button>
    </div>

    <div class="button-row">
      <button id="btnOutrasInfos" onclick="acessarOutrasInfos()"><i data-feather="menu"></i>Outras informa√ß√µes</button>
      <button id="btnToggleTabela" onclick="toggleTabela()"><i data-feather="eye"></i>Visualizar Tabela</button>
      <button onclick="sair()"><i data-feather="log-out"></i>Sair</button>
    </div>

    <div class="table-wrap" id="tabelaContainer" style="display:none;">
      <table id="tabelaChassi">
        <thead>
          <tr><th>Setor</th><th>Turno</th><th>Controlador de acesso</th><th>N√∫mero de chassi</th><th>Data e Hora</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal gen√©rico -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-container">
      <div class="modal-header" id="modalHeader"></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter">
        <button class="btn-modal btn-secondary" id="modalCancel">Cancelar</button>
        <button class="btn-modal btn-primary" id="modalConfirm">OK</button>
      </div>
    </div>
  </div>

  <script>
    const storageKey = 'tabelaChassi';
    let senhaOutrasInfos = localStorage.getItem('senhaOutrasInfos') || '1234';
    let tabelaDados = [];

    const showToast = (msg)=>{ const c=document.getElementById('toast-container'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; c.appendChild(t); setTimeout(()=>t.remove(),2600); };
    const atualizarTotal = ()=>{ document.getElementById('kpiTotal').textContent = "Total de ve√≠culos: " + tabelaDados.length; };

    // Tema
    (function(){
      const theme = localStorage.getItem('theme') || 'dark';
      if(theme==='light') document.documentElement.classList.add('theme-light');
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        document.documentElement.classList.toggle('theme-light');
        localStorage.setItem('theme', document.documentElement.classList.contains('theme-light') ? 'light' : 'dark');
      });
    })();

    function showModal(message) {
      return new Promise(resolve => {
        document.getElementById('modalHeader').textContent = '';
        document.getElementById('modalBody').textContent = message;
        document.getElementById('modalCancel').style.display = 'none';
        document.getElementById('modalConfirm').textContent = 'OK';
        document.getElementById('modalConfirm').onclick = () => { document.getElementById('modalOverlay').style.display = 'none'; resolve(); };
        document.getElementById('modalOverlay').style.display = 'flex';
      });
    }
    function showConfirm(message) {
      return new Promise(resolve => {
        document.getElementById('modalHeader').textContent = 'Confirma√ß√£o';
        document.getElementById('modalBody').textContent = message;
        document.getElementById('modalCancel').style.display = 'inline-block';
        document.getElementById('modalConfirm').textContent = 'Sim';
        document.getElementById('modalCancel').textContent = 'N√£o';
        document.getElementById('modalConfirm').onclick = () => { document.getElementById('modalOverlay').style.display = 'none'; resolve(true); };
        document.getElementById('modalCancel').onclick = () => { document.getElementById('modalOverlay').style.display = 'none'; resolve(false); };
        document.getElementById('modalOverlay').style.display = 'flex';
      });
    }
    function showPrompt(message) {
      return new Promise(resolve => {
        document.getElementById('modalHeader').textContent = 'Entrada de dados';
        const body = document.getElementById('modalBody');
        body.innerHTML = `<p>${message}</p><input type="text" id="modalInput" class="input" style="width:100%; margin-top:.5rem;">`;
        document.getElementById('modalCancel').style.display = 'inline-block';
        document.getElementById('modalConfirm').textContent = 'OK';
        document.getElementById('modalConfirm').onclick = () => { const val = document.getElementById('modalInput').value; document.getElementById('modalOverlay').style.display = 'none'; resolve(val); };
        document.getElementById('modalCancel').onclick = () => { document.getElementById('modalOverlay').style.display = 'none'; resolve(null); };
        document.getElementById('modalOverlay').style.display = 'flex';
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      feather.replace();
      tabelaDados = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const salvarLocal = ()=> localStorage.setItem(storageKey, JSON.stringify(tabelaDados));

      function atualizarTabela() {
        atualizarTotal();
        const tbody = document.querySelector("#tabelaChassi tbody");
        tbody.innerHTML = "";
        tabelaDados.forEach(item => {
          const tr = document.createElement("tr");
          tr.classList.add('row-enter');
          tr.innerHTML = `<td>${item.setor}</td><td>${item.turno}</td><td>${item.controlador}</td><td>${item.chassi}</td><td>${item.dataHora}</td>`;
          tbody.appendChild(tr);
        });
      }

      window.adicionarItem = async () => {
        atualizarTotal();
        const info = document.getElementById("kpiTotal");
        const inputChassi = document.getElementById("numeroChassi");
        const iconConfirm = document.getElementById("chassiConfirmIcon");
        const chassi = inputChassi.value.trim();
        const controlador = document.getElementById("controladorAcesso").value.trim();
        if (!chassi) { showToast("Digite o n√∫mero de chassi."); inputChassi.focus(); return; }
        if (!controlador) { showToast("Preencha o controlador de acesso."); document.getElementById("controladorAcesso").focus(); return; }
        tabelaDados.push({
          setor: document.getElementById("setor").value,
          turno: document.getElementById("turno").value,
          controlador: controlador,
          chassi: chassi,
          dataHora: new Date().toLocaleString("pt-BR")
        });
        salvarLocal();
        atualizarTabela();
        inputChassi.value = "";
        iconConfirm.classList.add("visible");
        feather.replace();
        setTimeout(() => { iconConfirm.classList.remove("visible"); }, 900);
        inputChassi.focus();
      };

      document.getElementById("numeroChassi").addEventListener("keypress", e => { if (e.key === "Enter") window.adicionarItem(); });

      window.desfazerUltimo = async () => {
        atualizarTotal();
        if (!tabelaDados.length) { await showModal("Nada para desfazer."); return; }
        tabelaDados.pop();
        localStorage.setItem(storageKey, JSON.stringify(tabelaDados));
        atualizarTabela();
        showToast("√öltimo item removido.");
      };

      window.toggleTabela = () => {
        const container = document.getElementById("tabelaContainer");
        const btn = document.getElementById("btnToggleTabela");
        const isHidden = container.style.display === "none";
        container.style.display = isHidden ? "block" : "none";
        btn.innerHTML = isHidden ? '<i data-feather="eye-off"></i>Ocultar Tabela' : '<i data-feather="eye"></i>Visualizar Tabela';
        feather.replace();
      };

      document.getElementById('numeroChassi').value = localStorage.getItem('draftChassi') || '';
      document.getElementById('controladorAcesso').value = (localStorage.getItem("usuario")||"") + " / " + (localStorage.getItem("registro")||"");
      atualizarTabela();
      ocultarBotoesInternos();

      if (tabelaDados.length) { await showModal('Dados restaurados.'); }
    });

    window.addEventListener('beforeunload', () => {
      localStorage.setItem('draftChassi', document.getElementById('numeroChassi').value);
      localStorage.setItem('draftControlador', document.getElementById('controladorAcesso').value);
    });

    window.sair = async () => { if (await showConfirm("Tem certeza que deseja sair?")) window.location.href = 'interface_principal.html'; };

    async function acessarOutrasInfos() {
      const senha = await showPrompt('Digite a senha de 4 d√≠gitos:');
      if (senha === senhaOutrasInfos) { document.getElementById('botoesInternos').style.display = 'flex'; }
      else { document.getElementById('botoesInternos').style.display = 'none'; await showModal('Senha incorreta.'); }
    }
    function ocultarBotoesInternos() { document.getElementById('botoesInternos').style.display = 'none'; }

    async function editarSenha() {
      const atual = await showPrompt('Digite a senha atual:');
      if (atual !== senhaOutrasInfos) { await showModal('Senha incorreta!'); return; }
      const nova = await showPrompt('Digite a nova senha de 4 d√≠gitos:');
      if (nova && nova.length === 4 && /^\\d+$/.test(nova)) {
        senhaOutrasInfos = nova; localStorage.setItem('senhaOutrasInfos', nova);
        await showModal('Senha alterada com sucesso!'); ocultarBotoesInternos();
      } else { await showModal('Senha inv√°lida!'); }
    }

    // Restaura turno salvo
    document.addEventListener('DOMContentLoaded', function() {
      try {
        var turnoSalvo = localStorage.getItem('turno');
        var turnosValidos = ['Alpha', 'Bravo', 'Charlie', 'Delta'];
        if (turnoSalvo && turnosValidos.includes(turnoSalvo)) {
          var campoTurno = document.getElementById('turno');
          if (campoTurno) campoTurno.value = turnoSalvo;
        }
      } catch(e) {}
    });
  </script>
</body>
</html>
